name: iOS CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - 'scripts/**'
      - '.editorconfig'
      - '.gitattributes'
      - '.gitignore'
      - '.nvmrc'
      - '.node-version'
      - '.prettierignore'
      - '.prettierrc'
      - '.prettierrc.*'
      - '.eslintrc'
      - '.eslintrc.*'
      - 'CODEOWNERS'
      - 'LICENSE*'
  pull_request:
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - 'scripts/**'
      - '.editorconfig'
      - '.gitattributes'
      - '.gitignore'
      - '.nvmrc'
      - '.node-version'
      - '.prettierignore'
      - '.prettierrc'
      - '.prettierrc.*'
      - '.eslintrc'
      - '.eslintrc.*'
      - 'CODEOWNERS'
      - 'LICENSE*'
  workflow_dispatch:

permissions:
  contents: read

env:
  IOS_DEVICE: 'iPhone 17'
  MAESTRO_VERSION: 'v2.0.3'

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios-quality-hosted:
    name: Format • Lint • Unit tests (iOS) - Hosted Ubuntu
    if: vars.USE_SELF_HOSTED != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.1.0
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Doctor
        run: npm run doctor
        continue-on-error: true

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run test

  ios-hosted:
    name: Build • E2E (iOS) - Hosted MacOS
    if: vars.USE_SELF_HOSTED != 'true'
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.1.0
          cache: 'npm'

      - name: Install EAS CLI
        shell: bash
        run: |
          npm i -g eas-cli@16.23.0
          eas --version

      - name: Make CI scripts executable
        run: chmod +x .github/scripts/*.sh

      - name: Setup Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler: 'none'
      - name: Setup Fastlane
        shell: bash
        run: .github/scripts/setup_fastlane.sh

      - name: Install deps
        run: npm ci

      - name: Doctor
        run: npm run doctor
        continue-on-error: true

      - name: Verify Expo/RN dependency alignment
        shell: bash
        run: |
          set -e
          npx expo --version || true
          node -e "console.log('react-native', require('react-native/package.json').version)" || true
          node -e "console.log('expo', require('expo/package.json').version)" || true
          # Strict: fail if mismatched so lockfile must be updated in a PR
          if ! npx expo install --check; then
            echo "❌ Expo dependency mismatch. Run 'npx expo install --fix' locally and commit the updated package-lock.json."
            exit 1
          fi

      - name: Cache Maestro CLI
        id: maestro-cache
        uses: actions/cache@v4
        with:
          path: ~/.maestro
          key: maestro-${{ runner.os }}-${{ env.MAESTRO_VERSION }}
          restore-keys: |
            maestro-${{ runner.os }}-

      - name: Setup Maestro
        if: steps.maestro-cache.outputs.cache-hit != 'true'
        shell: bash
        run: .github/scripts/setup_maestro.sh "${{ env.MAESTRO_VERSION }}"

      - name: Boot simulator
        shell: bash
        run: |
          xcrun simctl bootstatus "${{ env.IOS_DEVICE }}" -b || xcrun simctl boot "${{ env.IOS_DEVICE }}"
          xcrun simctl list | grep "${{ env.IOS_DEVICE }}" || exit 1

      - name: Build e2erelease on simulator
        run: eas build --platform ios --profile e2eRelease --local --non-interactive

      - name: Locate .app artifact
        id: find_app
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_TAR=$(ls -1t ./*.tar.gz 2>/dev/null | head -n1 || true)
          if [ -n "$ARTIFACT_TAR" ]; then
            echo "📦 Extracting $ARTIFACT_TAR ..."
            mkdir -p extracted_app
            tar -xzf "$ARTIFACT_TAR" -C extracted_app
          fi
          APP=$(find extracted_app -type d -name "*.app" -maxdepth 6 | head -n1 || true)
          echo "app=$APP" >> $GITHUB_OUTPUT
          [ -n "$APP" ] || (echo "No .app found after extracting $ARTIFACT_TAR"; ls -alh extracted_app || true; exit 1)

      - name: Install on simulator and warm up
        shell: bash
        run: |
          APP="${{ steps.find_app.outputs.app }}"
          BID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP/Info.plist")

          # Uninstall any existing copy first
          echo "🧹 Uninstalling $BID if already installed..."
          xcrun simctl uninstall booted "$BID" || true

          # Install fresh build
          echo "📦 Installing $APP ..."
          xcrun simctl install booted "$APP"

          # Launch once to warm it up
          echo "🚀 Launching $BID ..."
          xcrun simctl launch booted "$BID"
          sleep 5

      - name: Run E2E tests
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p e2e-artifacts
          set +e
          npm run e2e:ios -- --format junit --output e2e-artifacts/results-ios.xml
          CODE=$?
          set -e
          echo $CODE > e2e-artifacts/EXITCODE
          exit $CODE

      - name: Upload Xcode build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-build-artifacts-ios-hosted
          path: |
            ios/build/**/*.xcresult
            ios/build/**/*.log
            ~/Library/Developer/Xcode/DerivedData/**/Logs/Build/*.log
          if-no-files-found: ignore

      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-ios-hosted
          path: |
            e2e-artifacts/**/*
            ios/build/**/*.log
          include-hidden-files: true

      - name: Clean workspace
        if: ${{ always() }}
        shell: bash
        run: |
          echo "🧹 Cleaning hosted workspace (removing iOS build artifacts and E2E outputs)..."
          rm -rf ios/build e2e-artifacts || true

  ios-selfhosted:
    name: Lint • Test • Build • E2E (iOS) - Self-hosted MacOS
    if: vars.USE_SELF_HOSTED == 'true'
    runs-on: [self-hosted, macos, arm64]
    timeout-minutes: 45
    concurrency:
      group: selfhosted-mobile-${{ github.repository }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.1.0
          cache: 'npm'

      - name: Clean self-hosted workspace
        shell: bash
        run: .github/scripts/clean_selfhosted_workspace.sh

      - name: Make CI scripts executable
        run: chmod +x .github/scripts/*.sh

      - name: Check EAS CLI
        shell: bash
        run: |
          if ! command -v eas >/dev/null 2>&1; then
            echo "❌ EAS CLI not found on this runner."
            echo "Install it globally: npm i -g eas-cli@16.23.0"
            exit 1
          fi
          eas --version

      - name: Setup Fastlane
        shell: bash
        run: .github/scripts/setup_fastlane.sh

      - name: Install deps
        run: npm ci

      - name: Verify Expo/RN dependency alignment
        shell: bash
        run: |
          npx expo --version || true
          node -e "console.log('react-native', require('react-native/package.json').version)" || true
          node -e "console.log('expo', require('expo/package.json').version)" || true
          # Check (non-fatal) Expo SDK alignment
          npx expo install --check || true

      - name: Cache Maestro CLI
        id: maestro-cache
        uses: actions/cache@v4
        with:
          path: ~/.maestro
          key: maestro-${{ runner.os }}-${{ env.MAESTRO_VERSION }}
          restore-keys: |
            maestro-${{ runner.os }}-

      - name: Setup Maestro
        if: steps.maestro-cache.outputs.cache-hit != 'true'
        shell: bash
        run: .github/scripts/setup_maestro.sh "${{ env.MAESTRO_VERSION }}"

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run test

      - name: Doctor
        run: npm run doctor
        continue-on-error: true

      - name: Boot simulator
        shell: bash
        run: |
          xcrun simctl bootstatus "${{ env.IOS_DEVICE }}" -b || xcrun simctl boot "${{ env.IOS_DEVICE }}"
          xcrun simctl list | grep "${{ env.IOS_DEVICE }}" || exit 1

      - name: Build e2erelease on simulator
        run: eas build --platform ios --profile e2eRelease --local --non-interactive

      - name: Locate .app artifact
        id: find_app
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_TAR=$(ls -1t ./*.tar.gz 2>/dev/null | head -n1 || true)
          if [ -n "$ARTIFACT_TAR" ]; then
            echo "📦 Extracting $ARTIFACT_TAR ..."
            mkdir -p extracted_app
            tar -xzf "$ARTIFACT_TAR" -C extracted_app
          fi
          APP=$(find extracted_app -type d -name "*.app" -maxdepth 6 | head -n1 || true)
          echo "app=$APP" >> $GITHUB_OUTPUT
          [ -n "$APP" ] || (echo "No .app found after extracting $ARTIFACT_TAR"; ls -alh extracted_app || true; exit 1)

      - name: Install on simulator and warm up
        shell: bash
        run: |
          APP="${{ steps.find_app.outputs.app }}"
          BID=$(/usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$APP/Info.plist")

          # Uninstall any existing copy first
          echo "🧹 Uninstalling $BID if already installed..."
          xcrun simctl uninstall booted "$BID" || true

          # Install fresh build
          echo "📦 Installing $APP ..."
          xcrun simctl install booted "$APP"

          # Launch once to warm it up
          echo "🚀 Launching $BID ..."
          xcrun simctl launch booted "$BID"
          sleep 5

      - name: Run E2E tests
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p e2e-artifacts
          set +e
          npm run e2e:ios -- --format junit --output e2e-artifacts/results-ios.xml
          CODE=$?
          set -e
          echo $CODE > e2e-artifacts/EXITCODE
          exit $CODE

      - name: Upload Xcode build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-build-artifacts-ios-selfhosted
          path: |
            ios/build/**/*.xcresult
            ios/build/**/*.log
            ~/Library/Developer/Xcode/DerivedData/**/Logs/Build/*.log
          if-no-files-found: ignore

      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-ios-selfhosted
          path: |
            e2e-artifacts/**/*
            ios/build/**/*.log
          include-hidden-files: true
