name: Android CI - Hosted

on:
  workflow_call:
    inputs:
      env_prefix:
        description: Environment prefix (PROD or DEV)
        required: true
        type: string

permissions:
  contents: read

env:
  EXPO_USE_LOCAL_CLI: '1'
  METRO_CACHE_PATH: ${{ github.workspace }}/.metro-cache-ci
  ANDROID_TARGET: 'google_apis'
  ANDROID_API_LEVEL: 35
  MAESTRO_VERSION: '2.0.6'
  FASTLANE_VERSION: '2.228.0'

concurrency:
  group: android-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android-hosted:
    name: Build ‚Ä¢ E2E (Android) - Hosted Ubuntu
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      ANDROID_SDK_DIR: $HOME/Library/Android/sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node 24
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Setup Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler: 'none'

      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install deps
        run: npm ci

      - name: Map runtime variables and secrets
        shell: bash
        env:
          TURN_ON_FIREBASE: ${{ vars[format('{0}_TURN_ON_FIREBASE', inputs.env_prefix)] || vars.TURN_ON_FIREBASE || 'false' }}
          RETRIES_VALUE: ${{ vars[format('{0}_RETRIES', inputs.env_prefix)] || vars.RETRIES || '2' }}
          RETRY_DELAY_VALUE: ${{ vars[format('{0}_RETRY_DELAY', inputs.env_prefix)] || vars.RETRY_DELAY || '5' }}
          PROD_PUBLIC_SUPABASE_URL: ${{ vars.PROD_PUBLIC_SUPABASE_URL || '' }}
          DEV_PUBLIC_SUPABASE_URL: ${{ vars.DEV_PUBLIC_SUPABASE_URL || '' }}
          PROD_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PROD_PUBLIC_SUPABASE_ANON_KEY || '' }}
          DEV_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.DEV_PUBLIC_SUPABASE_ANON_KEY || '' }}
          PROD_SUPABASE_ACCESS_TOKEN: ${{ secrets.PROD_SUPABASE_ACCESS_TOKEN || '' }}
          DEV_SUPABASE_ACCESS_TOKEN: ${{ secrets.DEV_SUPABASE_ACCESS_TOKEN || '' }}
        run: |
          echo "EXPO_PUBLIC_TURN_ON_FIREBASE=$TURN_ON_FIREBASE" >> "$GITHUB_ENV"
          echo "RETRIES=$RETRIES_VALUE" >> "$GITHUB_ENV"
          echo "RETRY_DELAY=$RETRY_DELAY_VALUE" >> "$GITHUB_ENV"

          if [ "${{ inputs.env_prefix }}" = "PROD" ]; then
            echo "EXPO_PUBLIC_SUPABASE_URL=$PROD_PUBLIC_SUPABASE_URL" >> "$GITHUB_ENV"
            echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=$PROD_PUBLIC_SUPABASE_ANON_KEY" >> "$GITHUB_ENV"
            echo "SUPABASE_ACCESS_TOKEN=$PROD_SUPABASE_ACCESS_TOKEN" >> "$GITHUB_ENV"
          else
            echo "EXPO_PUBLIC_SUPABASE_URL=$DEV_PUBLIC_SUPABASE_URL" >> "$GITHUB_ENV"
            echo "EXPO_PUBLIC_SUPABASE_ANON_KEY=$DEV_PUBLIC_SUPABASE_ANON_KEY" >> "$GITHUB_ENV"
            echo "SUPABASE_ACCESS_TOKEN=$DEV_SUPABASE_ACCESS_TOKEN" >> "$GITHUB_ENV"
          fi

      - name: Install EAS CLI
        shell: bash
        run: |
          npm i -g eas-cli@16.23.0
          eas --version

      - name: Make CI scripts executable
        run: chmod +x .github/scripts/*.sh

      - name: Setup Fastlane
        shell: bash
        run: .github/scripts/setup_fastlane.sh  "${{ env.FASTLANE_VERSION }}"

      - name: Verify Expo/RN dependency alignment
        shell: bash
        run: |
          set -e
          npx expo --version || true
          node -e "console.log('react-native', require('react-native/package.json').version)" || true
          node -e "console.log('expo', require('expo/package.json').version)" || true
          # Strict: fail if mismatched so lockfile must be updated in a PR
          if ! npx expo install --check; then
            echo "‚ùå Expo dependency mismatch. Run 'npx expo install --fix' locally and commit the updated package-lock.json."
            exit 1
          fi

      - name: Setup Maestro
        shell: bash
        run: .github/scripts/setup_maestro.sh "${{ env.MAESTRO_VERSION }}"

      - name: Compute Android build fingerprint
        id: android_fingerprint
        shell: bash
        env:
          GOOGLE_SERVICE_INFO_PLIST_B64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_B64 }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: ./.github/scripts/compute_fingerprint.sh android >> "$GITHUB_OUTPUT"

      - name: Restore cached APK
        id: apk-cache
        uses: actions/cache/restore@v4
        with:
          path: ./*.apk
          key: ${{ steps.android_fingerprint.outputs.key }}

      - name: Create debug keystore
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p android
          keytool -genkeypair -v \
            -keystore "android/debug.keystore" \
            -storepass android -keypass android \
            -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Write signing props for Gradle
        if: steps.apk-cache.outputs.cache-hit != 'true'
        run: |
          echo "android.injected.signing.store.file=$PWD/android/debug.keystore" >> android/gradle.properties
          echo "android.injected.signing.store.password=android"               >> android/gradle.properties
          echo "android.injected.signing.key.alias=androiddebugkey"            >> android/gradle.properties
          echo "android.injected.signing.key.password=android"                 >> android/gradle.properties

      # Lean caching: only Gradle to stay under 10GB org-wide cache budget
      - name: Cache Gradle (caches + wrapper + project .gradle)
        if: steps.apk-cache.outputs.cache-hit != 'true'
        id: gradle-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'android/**/build.gradle', 'android/**/gradle.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build e2erelease APK
        if: steps.apk-cache.outputs.cache-hit != 'true'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          GOOGLE_SERVICE_INFO_PLIST_B64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_B64 }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
          EXPO_PUBLIC_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          EXPO_PUBLIC_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          EXPO_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          EXPO_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.FIREBASE_MEASUREMENT_ID }}
          EXPO_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          EXPO_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          EXPO_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ vars.PROD_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PROD_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.PROD_SUPABASE_ACCESS_TOKEN }}
        run: |
          set -e
          ATTEMPTS="${RETRIES:-2}"
          DELAY="${RETRY_DELAY:-5}"

          for attempt in $(seq 1 "$ATTEMPTS"); do
            echo "üèóÔ∏è Build attempt $attempt/$ATTEMPTS"
            if eas build --platform android --profile e2eRelease --local --non-interactive; then
              echo "‚úÖ Build succeeded"
              exit 0
            fi
            if [ "$attempt" -lt "$ATTEMPTS" ]; then
              echo "‚ö†Ô∏è Build failed; retrying in $DELAY s..."
              sleep "$DELAY"
            fi
          done

          echo "‚ùå Build failed after $ATTEMPTS attempts"
          exit 1

      - name: Locate APK artifact & app.config.ts
        id: find_apk
        shell: bash
        run: |
          set -euo pipefail
          APK="$(ls -1t ./*.apk 2>/dev/null | head -n1 || true)"
          echo "APK=$APK"
          echo "apk=$APK" >> $GITHUB_OUTPUT
          [ -n "$APK" ] || (echo "No APK found in repo root."; ls -alh .; exit 1)

          PKG=$(node -e "const { execSync } = require('node:child_process'); const config = JSON.parse(execSync('npx expo config --json', { encoding: 'utf8' })); process.stdout.write(config.android?.package ?? '');")
          echo "PKG=$PKG"
          echo "pkg=$PKG" >> $GITHUB_OUTPUT
          [ -n "$PKG" ] || (echo "No PKG found in repo root."; ls -alh .; exit 1)

      - name: Save APK to cache
        if: steps.apk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.find_apk.outputs.apk }}
          key: ${{ steps.android_fingerprint.outputs.key }}

      - name: Run context snippet (engine + native project state)
        if: steps.apk-cache.outputs.cache-hit == 'true'
        shell: bash
        run: |
          echo "[run-snippet] pwd"
          pwd

          echo "[run-snippet] android directory state"
          if [ -d android ]; then
            echo "android exists"
          else
            echo "android missing"
          fi

          if [ -f android/gradle.properties ]; then
            echo "[run-snippet] android/gradle.properties (engine lines)"
            grep -En "hermes|jsengine|jsEngine|newarch|newArch" android/gradle.properties || true
          else
            echo "[run-snippet] android/gradle.properties missing"
          fi

          if [ -f android/app/build.gradle ]; then
            echo "[run-snippet] android/app/build.gradle (engine lines)"
            grep -En "hermes|jsengine|jsEngine|newarch|newArch|enableHermes" android/app/build.gradle || true
          else
            echo "[run-snippet] android/app/build.gradle missing"
          fi

          echo "[run-snippet] expo public config (engine/runtime lines)"
          node -e "const { execSync } = require('node:child_process'); const config = JSON.parse(execSync('npx expo config --json', { encoding: 'utf8' })); const payload = { jsEngine: config.jsEngine ?? null, newArchEnabled: config.newArchEnabled ?? null, runtimeVersion: config.runtimeVersion ?? null, androidPackage: config.android?.package ?? null }; console.log(JSON.stringify(payload, null, 2));"

      - name: Repack Android app with latest JS bundle
        if: steps.apk-cache.outputs.cache-hit == 'true'
        shell: bash
        env:
          PLATFORM: android
          SOURCE_APP: ${{ steps.find_apk.outputs.apk }}
          METRO_CACHE_PATH: ${{ github.workspace }}/.metro-cache-ci
          GOOGLE_SERVICE_INFO_PLIST_B64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_B64 }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          set -euo pipefail

          RESOLVED_SDK_DIR="${ANDROID_SDK_DIR/#\$HOME/$HOME}"
          if [ ! -d "$RESOLVED_SDK_DIR/build-tools" ]; then
            for candidate in "$HOME/Library/Android/sdk" "${ANDROID_HOME:-}" "${ANDROID_SDK_ROOT:-}"; do
              if [ -n "$candidate" ] && [ -d "$candidate/build-tools" ]; then
                RESOLVED_SDK_DIR="$candidate"
                break
              fi
            done
          fi

          if [ ! -d "$RESOLVED_SDK_DIR/build-tools" ]; then
            echo "‚ùå Unable to find Android build-tools under expected SDK paths."
            echo "Checked: $RESOLVED_SDK_DIR, $HOME/Library/Android/sdk, ${ANDROID_HOME:-<unset>}, ${ANDROID_SDK_ROOT:-<unset>}"
            exit 1
          fi

          export ANDROID_SDK_ROOT="$RESOLVED_SDK_DIR"
          export ANDROID_HOME="$RESOLVED_SDK_DIR"

          echo "üßπ Removing native folders before JS export to avoid stale Hermes/native mismatch checks"
          rm -rf ./android ./ios

          echo "üì¶ Building embedded Android bundle for repack..."
          rm -rf dist

          npx expo export:embed \
            --platform android \
            --entry-file index.js \
            --bundle-output dist/index.android.bundle \
            --assets-dest dist/assets \
            --dev false

          echo "export:embed" > dist/.bundle-source

          if [ ! -f dist/index.android.bundle ]; then
            echo "‚ùå index.android.bundle not generated"
            exit 1
          fi

          if [ ! -d dist/assets ]; then
            echo "‚ùå assets directory not generated"
            exit 1
          fi

          echo "üîç Verifying dist folder contents:"
          find ./dist -maxdepth 4 -print

      - name: Validate Hermes + bundle compatibility before repack
        if: steps.apk-cache.outputs.cache-hit == 'true'
        shell: bash
        run: |
          set -euo pipefail

          EXPO_CONFIG_JSON="$(npx expo config --json)"
          if [ -z "$EXPO_CONFIG_JSON" ]; then
            echo "‚ùå Failed to load Expo config JSON"
            exit 1
          fi

          EXPECTED_ENGINE="$(node -e "const cfg = JSON.parse(process.argv[1]); const engine = cfg.android?.jsEngine ?? cfg.jsEngine ?? 'hermes'; process.stdout.write(String(engine).toLowerCase());" "$EXPO_CONFIG_JSON")"
          if [ -z "$EXPECTED_ENGINE" ]; then
            echo "‚ùå Could not determine expected JS engine from Expo config"
            exit 1
          fi

          BUNDLE_PATH="dist/index.android.bundle"
          ASSETS_PATH="dist/assets"

          if [ ! -d dist ]; then
            echo "‚ùå dist folder is missing"
            exit 1
          fi

          if [ -z "$(find dist -mindepth 1 -maxdepth 1 -print -quit)" ]; then
            echo "‚ùå dist folder is empty"
            exit 1
          fi

          if [ ! -f "$BUNDLE_PATH" ]; then
            echo "‚ùå Bundle file missing: $BUNDLE_PATH"
            exit 1
          fi

          if [ ! -s "$BUNDLE_PATH" ]; then
            echo "‚ùå Bundle file is empty: $BUNDLE_PATH"
            exit 1
          fi

          if [ ! -d "$ASSETS_PATH" ]; then
            echo "‚ùå Required assets directory missing: $ASSETS_PATH"
            exit 1
          fi

          BUNDLE_SIZE="$(wc -c < "$BUNDLE_PATH" | tr -d ' ')"
          HAS_HERMES_MARKER="no"
          if grep -a -q "Hermes" "$BUNDLE_PATH"; then
            HAS_HERMES_MARKER="yes"
          fi

          BUNDLE_SOURCE=""
          if [ -f dist/.bundle-source ]; then
            BUNDLE_SOURCE="$(cat dist/.bundle-source)"
          fi

          if [ "$EXPECTED_ENGINE" = "hermes" ] && [ "$HAS_HERMES_MARKER" != "yes" ] && [ "$BUNDLE_SOURCE" != "export:embed" ]; then
            echo "‚ùå Hermes expected but bundle has no Hermes marker and was not produced by export:embed"
            exit 1
          fi

          echo "[validation] expected engine: $EXPECTED_ENGINE"
          echo "[validation] bundle path: $BUNDLE_PATH"
          echo "[validation] bundle file size (bytes): $BUNDLE_SIZE"
          echo "[validation] hermes marker present: $HAS_HERMES_MARKER"
          echo "[validation] bundle source: ${BUNDLE_SOURCE:-unknown}"

      - name: Repack Android app artifact with embedded bundle
        if: steps.apk-cache.outputs.cache-hit == 'true'
        shell: bash
        env:
          PLATFORM: android
          SOURCE_APP: ${{ steps.find_apk.outputs.apk }}
        run: |
          set -euo pipefail

          RESOLVED_SDK_DIR="${ANDROID_SDK_DIR/#\$HOME/$HOME}"
          if [ ! -d "$RESOLVED_SDK_DIR/build-tools" ]; then
            for candidate in "$HOME/Library/Android/sdk" "${ANDROID_HOME:-}" "${ANDROID_SDK_ROOT:-}"; do
              if [ -n "$candidate" ] && [ -d "$candidate/build-tools" ]; then
                RESOLVED_SDK_DIR="$candidate"
                break
              fi
            done
          fi

          if [ ! -d "$RESOLVED_SDK_DIR/build-tools" ]; then
            echo "‚ùå Unable to find Android build-tools for repack-app."
            echo "Checked: $RESOLVED_SDK_DIR, $HOME/Library/Android/sdk, ${ANDROID_HOME:-<unset>}, ${ANDROID_SDK_ROOT:-<unset>}"
            exit 1
          fi

          export ANDROID_SDK_ROOT="$RESOLVED_SDK_DIR"
          export ANDROID_HOME="$RESOLVED_SDK_DIR"

          TEMP_OUTPUT="repacked_output"
          rm -rf "$TEMP_OUTPUT"
          npx @expo/repack-app --platform "$PLATFORM" --source-app "$SOURCE_APP" --output "$TEMP_OUTPUT"
          echo "Replacing $SOURCE_APP with repacked version..."
          rm -rf "$SOURCE_APP"
          mv "$TEMP_OUTPUT" "$SOURCE_APP"

      - name: Upload Gradle reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-reports-android-hosted
          path: |
            android/build/reports/**
            android/app/build/reports/**
          if-no-files-found: ignore

      - name: Save Gradle cache (post-build)
        if: always() && steps.apk-cache.outputs.cache-hit != 'true' && steps.gradle-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'android/**/build.gradle', 'android/**/gradle.properties') }}

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run E2E tests
        id: e2e_android
        uses: reactivecircus/android-emulator-runner@v2
        timeout-minutes: 30 # Android emulators are slow
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          target: ${{ env.ANDROID_TARGET }}
          arch: x86_64
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: .github/scripts/android_run_e2e.sh ${{ steps.find_apk.outputs.apk }} ${{ steps.find_apk.outputs.pkg }}

      - name: Collect emulator logs on failure
        if: failure() && steps.e2e_android.outcome == 'failure'
        shell: bash
        run: |
          echo "Collecting emulator diagnostics..."
          adb logcat -d > e2e-artifacts/emulator.log || true
          adb shell "getprop" > e2e-artifacts/device-props.txt || true
          mkdir -p e2e-artifacts
          echo "‚úÖ Logs collected"

      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-android-hosted
          path: |
            e2e-artifacts/**/*
            android/app/build/reports/**
          include-hidden-files: true
