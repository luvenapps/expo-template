name: iOS CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.editorconfig'
      - '.gitattributes'
      - '.gitignore'
      - '.nvmrc'
      - '.node-version'
      - '.prettierignore'
      - '.prettierrc'
      - '.prettierrc.*'
      - '.eslintrc'
      - '.eslintrc.*'
      - 'CODEOWNERS'
      - 'LICENSE*'
  pull_request:
    paths-ignore:
      - '**/*.md'
      - '**/*.mdx'
      - 'docs/**'
      - '.editorconfig'
      - '.gitattributes'
      - '.gitignore'
      - '.nvmrc'
      - '.node-version'
      - '.prettierignore'
      - '.prettierrc'
      - '.prettierrc.*'
      - '.eslintrc'
      - '.eslintrc.*'
      - 'CODEOWNERS'
      - 'LICENSE*'
  workflow_dispatch:

permissions:
  contents: read

env:
  IOS_DEVICE: 'iPhone 17'
  MAESTRO_VERSION: '2.0.6'
  FASTLANE_VERSION: '2.228.0'
  EAS_PROJECT_ID: ${{ vars.EAS_PROJECT_ID }}
  RETRIES: ${{ vars.RETRIES }}
  RETRY_DELAY: ${{ vars.RETRY_DELAY }}
  MAESTRO_DRIVER_STARTUP_TIMEOUT: 60000

concurrency:
  group: ios-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ios-quality-hosted:
    name: Format ‚Ä¢ Lint ‚Ä¢ Unit tests (iOS) - Hosted Ubuntu
    if: vars.USE_SELF_HOSTED != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: expo-template-testing
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.1.0
          cache: 'npm'

      - name: Scaffold & verify (retry once)
        working-directory: .
        shell: bash
        run: |
          set -euo pipefail
          max=2
          attempt=1
          while [ "$attempt" -le "$max" ]; do
            echo "==> Attempt $attempt/$max: scaffold + verify"
            rm -rf expo-template-testing || true
            npx create-expo-app expo-template-testing --template "$GITHUB_WORKSPACE" --yes
            pushd expo-template-testing >/dev/null
            npx expo --version || true
            node -e "console.log('react-native', require('react-native/package.json').version)" || true
            node -e "console.log('expo', require('expo/package.json').version)" || true
            if npx expo install --check; then
              echo "‚úÖ Expo dependency alignment OK"
              popd >/dev/null
              break
            fi
            popd >/dev/null
            if [ "$attempt" -lt "$max" ]; then
              echo "‚ö†Ô∏è Verification failed. Retrying from scratch..." >&2
              attempt=$((attempt+1))
              continue
            else
              echo "‚ùå Verification failed after $max attempts." >&2
              exit 1
            fi
          done

      - name: Doctor
        run: npm run doctor
        continue-on-error: true

      - name: Check formatting
        run: npm run format:check

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run test

  ios-hosted:
    name: Build ‚Ä¢ E2E (iOS) - Hosted MacOS
    if: vars.USE_SELF_HOSTED != 'true'
    runs-on: macos-latest
    timeout-minutes: 45
    defaults:
      run:
        working-directory: expo-template-testing

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node 24
        uses: actions/setup-node@v4
        with:
          node-version: 24.1.0
          cache: 'npm'

      - name: Setup Ruby (for Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler: 'none'

      - name: Scaffold & verify (retry once)
        working-directory: .
        shell: bash
        run: |
          set -euo pipefail
          max=2
          attempt=1
          while [ "$attempt" -le "$max" ]; do
            echo "==> Attempt $attempt/$max: scaffold + verify"
            rm -rf expo-template-testing || true
            npx create-expo-app expo-template-testing --template "$GITHUB_WORKSPACE" --yes
            pushd expo-template-testing >/dev/null
            npx expo --version || true
            node -e "console.log('react-native', require('react-native/package.json').version)" || true
            node -e "console.log('expo', require('expo/package.json').version)" || true
            if npx expo install --check; then
              echo "‚úÖ Expo dependency alignment OK"
              popd >/dev/null
              break
            fi
            popd >/dev/null
            if [ "$attempt" -lt "$max" ]; then
              echo "‚ö†Ô∏è Verification failed. Retrying from scratch..." >&2
              attempt=$((attempt+1))
              continue
            else
              echo "‚ùå Verification failed after $max attempts." >&2
              exit 1
            fi
          done

      - name: Install EAS CLI
        shell: bash
        run: |
          npm i -g eas-cli@16.23.0
          eas --version

      - name: Make CI scripts executable
        run: chmod +x .github/scripts/*.sh
        
      - name: Setup Fastlane
        shell: bash
        run: .github/scripts/setup_fastlane.sh  "${{ env.FASTLANE_VERSION }}"

      - name: Doctor
        run: npm run doctor
        continue-on-error: true

      - name: Verify Expo/RN dependency alignment
        shell: bash
        run: |
          set -e
          npx expo --version || true
          node -e "console.log('react-native', require('react-native/package.json').version)" || true
          node -e "console.log('expo', require('expo/package.json').version)" || true
          # Strict: fail if mismatched so lockfile must be updated in a PR
          if ! npx expo install --check; then
            echo "‚ùå Expo dependency mismatch. Run 'npx expo install --fix' locally and commit the updated package-lock.json."
            exit 1
          fi

      - name: Setup Maestro
        shell: bash
        run: .github/scripts/setup_maestro.sh "${{ env.MAESTRO_VERSION }}"

      - name: Inject EAS projectId, slug and owner into app.json
        shell: bash
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const path = './app.json';
          const EAS_PROJECT_ID = '${{ env.EAS_PROJECT_ID }}';
          const OWNER = 'luvenapps';
          const SLUG = 'expo-template';

          if (!fs.existsSync(path)) {
            console.error(`app.json not found at ${path}`);
            process.exit(1);
          }

          const json = JSON.parse(fs.readFileSync(path, 'utf8'));
          json.expo = json.expo || {};
          json.expo.extra = json.expo.extra || {};
          json.expo.extra.router = json.expo.extra.router || {};
          json.expo.extra.eas = Object.assign({}, json.expo.extra.eas || {}, { projectId: EAS_PROJECT_ID });
          json.expo.owner = OWNER;
          json.expo.slug = SLUG;

          fs.writeFileSync(path, JSON.stringify(json, null, 2) + '\n');
          console.log('Updated app.json with extra.eas.projectId, slug and owner.');
          NODE

      - name: Compute iOS build fingerprint
        id: ios_fp
        shell: bash
        run: |
          set -euo pipefail
          FILES="$(git ls-files \
            'app.json' \
            'app.config.*' \
            'eas.json' \
            'package.json' \
            'package-lock.json' \
            'babel.config.*' \
            'metro.config.*' \
            'tsconfig.*' \
            'index.*' \
            '*.env' '.env.*' \
            'scripts/**' \
            'app/**' 'src/**' 'components/**' 'screens/**' \
            'App.*' \
            'plugins/**' \
            'assets/**' \
            '**/*.png' '**/*.svg' '**/*.ttf' '**/*.otf' \
            'ios/**' \
          )"
          SALT="node=$(node -v);xcode=$(xcodebuild -version | tr '\n' ' ')"
          HASH=$( (echo "$SALT"; echo "$FILES"; echo "$FILES" | xargs -I{} shasum "{}") | shasum -a 256 | awk '{print $1}' )
          echo "key=ios-app-${HASH}" >> "$GITHUB_OUTPUT"

      - name: Restore the tar.gz iOS app
        id: ios_cache
        uses: actions/cache/restore@v4
        with:
          path: expo-template-testing/*.tar.gz
          key: ${{ steps.ios_fp.outputs.key }}

      - name: Build e2erelease
        if: steps.ios_cache.outputs.cache-hit != 'true'
        shell: bash
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail
          ATTEMPTS="${RETRIES:-2}"
          DELAY="${RETRY_DELAY:-2}"
          i=1
          while [ "$i" -le "$ATTEMPTS" ]; do
            echo "üèóÔ∏è  iOS build attempt $i/$ATTEMPTS..."
            if eas build --platform ios --profile e2eRelease --local --non-interactive; then
              echo "‚úÖ Build succeeded on attempt $i"
              exit 0
            fi
            if [ "$i" -lt "$ATTEMPTS" ]; then
              echo "‚ùå Build attempt $i failed ‚Äî retrying in ${DELAY}s..."
              sleep "$DELAY"
            fi
            i=$((i+1))
          done
          echo "‚ùå Build failed after $ATTEMPTS attempts"
          exit 1

      - name: Locate .app artifact
        id: find_app
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_TAR=$(ls -1t ./*.tar.gz 2>/dev/null | head -n1 || true)
          if [ -n "$ARTIFACT_TAR" ]; then
            echo "üì¶ Extracting $ARTIFACT_TAR ..."
            mkdir -p extracted_app
            tar -xzf "$ARTIFACT_TAR" -C extracted_app
          fi
          # Strip leading ./ for cache path compatibility
          TAR_BASENAME="${ARTIFACT_TAR#./}"
          echo "tar=$TAR_BASENAME" >> $GITHUB_OUTPUT
          APP=$(find extracted_app -type d -name "*.app" -maxdepth 6 | head -n1 || true)
          echo "app=$APP" >> $GITHUB_OUTPUT
          [ -n "$APP" ] || (echo "No .app found after extracting $ARTIFACT_TAR"; ls -alh extracted_app || true; exit 1)
          
      - name: Save the tar.gz iOS app
        if: steps.ios_cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: expo-template-testing/*.tar.gz
          key: ${{ steps.ios_fp.outputs.key }}

      - name: Boot simulator
        shell: bash
        run: .github/scripts/ios_boot_simulator.sh

      - name: Install on simulator and warm up
        shell: bash
        timeout-minutes: 10
        run: .github/scripts/ios_install_app.sh "${{ steps.find_app.outputs.app }}"

      - name: Run E2E tests
        shell: bash
        run: .github/scripts/ios_run_e2e.sh

      - name: Upload Xcode build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-build-artifacts-ios-hosted
          path: |
            expo-template-testing/ios/build/**/*.xcresult
            expo-template-testing/ios/build/**/*.log
            ~/Library/Developer/Xcode/DerivedData/**/Logs/Build/*.log
          if-no-files-found: ignore

      - name: Upload E2E artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-ios-hosted
          path: |
            expo-template-testing/e2e-artifacts/**/*
            expo-template-testing/ios/build/**/*.log
          include-hidden-files: true

      - name: Clean workspace
        if: ${{ always() }}
        shell: bash
        run: |
          echo "üßπ Cleaning hosted workspace (removing iOS build artifacts and E2E outputs)..."
          rm -rf ios/build e2e-artifacts || true

